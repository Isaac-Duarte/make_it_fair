<!DOCTYPE html>
<html>
<head>
    <title>Make it fair</title>
    <style>
        #radar {
            position: relative;
            width: 1024px; /* Adjust to your radar image size */
            height: 1024px;
            background-image: url('assets/image/de_dust2_radar_psd.png');
            background-size: cover;
            background-position: center;
        }
        .player-icon {
            position: absolute;
            transform: translate(-50%, -50%);
            transition: top 0.1s linear, left 0.1s linear;
        }
        .player-rotation {
            position: relative;
            width: 14px; /* Adjusted to accommodate arrow */
            height: 14px;
            transform-origin: center center;
        }
        .player-dot {
            width: 10px;
            height: 10px;
            background-color: red; /* Change color based on team */
            border-radius: 50%;
            border: 2px solid white; /* Optional: add a border for better visibility */
            position: absolute;
            top: 2px;
            left: 2px;
        }
        .player-arrow {
            width: 0;
            height: 0;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            border-bottom: 14px solid yellow; /* Color of the arrow */
            position: absolute;
            top: -12px; /* Adjust this value to position the arrow correctly */
            left: 0;
            right: 0;
            margin: auto;
        }
        .player-info {
            position: absolute;
            top: 16px; /* Slightly adjusted to account for new padding */
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            text-align: center;
            font-size: 11px;
            color: white;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent background */
            padding: 6px;
            border-radius: 5px;
        }
        .player-info .name {
            font-weight: bold;
            color: #FFD700; /* Gold color for player names */
        }
        .player-info .health-armor,
        .player-info .weapon {
            margin-top: 3px;
            font-size: 0.8rem;
            color: #E0E0E0; /* Light gray for subtext */
        }
    </style>
</head>
<body>
    <div id="radar"></div>

    <script>
        // Mapping parameters
        const mapping = {
            pos_x: -2476.0,
            pos_y: 3239.0,
            scale: 4.400000095367432,
            rotate: 1,
            zoom: 1.100000023841858
        };

        // Keep track of player elements
        const playerElements = {};

        // WebSocket connection
        const ws = new WebSocket('wss://' + window.location.host + '/ws');

        ws.onopen = function() {
            console.log('WebSocket connection established.');
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            updatePlayers(data.players);
        };

        function updatePlayers(players) {
            const radar = document.getElementById('radar');
            const currentIds = new Set();

            players.forEach(player => {
                const playerId = player.name; // Use player.name or another unique property
                currentIds.add(playerId);

                let icon = playerElements[playerId];

                // Assuming player.rotation is in radians, convert to degrees
                if (player.name == "/home/fozie") {
                    console.log(player.rotation.y);
                }
                const rotationDegrees = (-player.rotation.y * mapping.rotate + 90);

                if (icon) {
                    // Update existing icon
                    const pos = convertPosition(player.position);
                    icon.style.left = `${pos.y}px`;
                    icon.style.top = `${pos.x}px`;

                    // Update rotation
                    const rotationContainer = icon.querySelector('.player-rotation');
                    rotationContainer.style.transform = `rotate(${rotationDegrees}deg)`;

                    // Update player info
                    const info = icon.querySelector('.player-info');

                    const name = info.querySelector('.name');
                    name.textContent = player.name;

                    const healthArmor = info.querySelector('.health-armor');
                    healthArmor.textContent = `HP: ${player.health} / Armor: ${player.armor}`;

                    const weapon = info.querySelector('.weapon');
                    weapon.textContent = `Weapon: ${player.weapon}`;

                    // Update team color
                    const dot = icon.querySelector('.player-dot');
                    if (player.team === 'Terrorist') {
                        dot.style.backgroundColor = 'red';
                    } else if (player.team === 'CounterTerrorist') {
                        dot.style.backgroundColor = 'blue';
                    }
                } else {
                    // Create new icon
                    const newIcon = document.createElement('div');
                    newIcon.classList.add('player-icon');

                    // Create rotation container
                    const rotationContainer = document.createElement('div');
                    rotationContainer.classList.add('player-rotation');
                    rotationContainer.style.transform = `rotate(${rotationDegrees}deg)`;

                    // Create dot representing the player
                    const dot = document.createElement('div');
                    dot.classList.add('player-dot');

                    // Color-code based on team
                    if (player.team === 'Terrorist') {
                        dot.style.backgroundColor = 'red';
                    } else if (player.team === 'CounterTerrorist') {
                        dot.style.backgroundColor = 'blue';
                    }

                    // Create arrow representing the player's facing direction
                    const arrow = document.createElement('div');
                    arrow.classList.add('player-arrow');

                    // Append dot and arrow to rotation container
                    rotationContainer.appendChild(dot);
                    rotationContainer.appendChild(arrow);

                    // Player info container
                    const info = document.createElement('div');
                    info.classList.add('player-info');

                    // Player name
                    const name = document.createElement('div');
                    name.classList.add('name');
                    name.textContent = player.name;
                    info.appendChild(name);

                    // Health and Armor
                    const healthArmor = document.createElement('div');
                    healthArmor.classList.add('health-armor');
                    healthArmor.textContent = `HP: ${player.health} / Armor: ${player.armor}`;
                    info.appendChild(healthArmor);

                    // Weapon
                    const weapon = document.createElement('div');
                    weapon.classList.add('weapon');
                    weapon.textContent = `Weapon: ${player.weapon}`;
                    info.appendChild(weapon);

                    // Append rotation container and info to icon
                    newIcon.appendChild(rotationContainer);
                    newIcon.appendChild(info);

                    // Convert player position to radar coordinates
                    const pos = convertPosition(player.position);
                    newIcon.style.left = `${pos.y}px`;
                    newIcon.style.top = `${pos.x}px`;

                    radar.appendChild(newIcon);
                    playerElements[playerId] = newIcon;
                }
            });

            // Remove any icons for players that are no longer present
            for (const id in playerElements) {
                if (!currentIds.has(id)) {
                    const icon = playerElements[id];
                    icon.parentNode.removeChild(icon);
                    delete playerElements[id];
                }
            }
        }

        function convertPosition(position) {
            const radar = document.getElementById('radar');
            const radarWidth = radar.clientWidth;
            const radarHeight = radar.clientHeight;

            let x = (position.x - mapping.pos_x) / mapping.scale;
            let y = (mapping.pos_y - position.y) / mapping.scale;

            if (mapping.rotate) {
                [x, y] = [y, x];
            }

            // Map to radar image dimensions
            x = x * (radarWidth / 1024);
            y = y * (radarHeight / 1024);

            return { x, y };
        }
    </script>
</body>
</html>
